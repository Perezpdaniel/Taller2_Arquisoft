<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" xmlns:h="http://xmlns.jakarta.ee/jsf/html" xmlns:f="http://xmlns.jakarta.ee/jsf/core" xmlns:ui="http://xmlns.jakarta.ee/jsf/facelets">
  <h:head>
    <title>Reservations - Hotel Reservation Management System</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet" />
    <style>
      .form-container { background: #f8f9fa; border-radius: 10px; padding: 30px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
      .table-container { background: #fff; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); overflow: hidden; }
    </style>
  </h:head>
  <h:body>
    <f:view>
    <!-- Initialize the bean -->
    <f:event type="preRenderView" listener="#{reservationBean.initialize()}"/>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-light bg-light shadow-sm">
      <div class="container">
        <h:link outcome="/index" styleClass="navbar-brand fw-bold text-primary">
          <i class="fas fa-hotel me-2"></i>Hotel Reservation Management System
        </h:link>
      </div>
    </nav>

    <div class="container my-5">
      <!-- Header -->
      <div class="row mb-4">
        <div class="col">
          <div class="d-flex justify-content-between align-items-start">
            <div>
              <h2 class="fw-bold text-primary">
                <i class="fas fa-calendar-check me-2"></i>Reservations Management
              </h2>
              <p class="text-muted">Manage the reservations of the hotel's rooms</p>
            </div>
            <button type="button" class="btn btn-outline-primary" onclick="window.location.href='../index.xhtml'">
              <i class="fas fa-home me-1"></i>Home
            </button>
          </div>
        </div>
      </div>

      <!-- Messages -->
      <h:messages globalOnly="false" showDetail="true" showSummary="true"
                  styleClass="alert" infoClass="alert alert-info" errorClass="alert alert-danger" warnClass="alert alert-warning"/>

      <!-- Action Buttons -->
      <div class="row mb-4">
        <div class="col">
          <div class="card">
            <div class="card-body text-center">
              <h:form style="display: inline;">
                <h:commandButton value="New Reservation" action="#{reservationBean.newReservation()}" styleClass="btn btn-success btn-lg me-3" immediate="true" onclick="scrollToForm()">
                  <i class="fas fa-calendar-plus me-2"></i>
                </h:commandButton>
              </h:form>
              <button type="button" class="btn btn-info btn-lg" onclick="scrollToSearch()">
                <i class="fas fa-search me-2"></i>Search Reservations
              </button>
            </div>
          </div>
        </div>
      </div>

      <!-- Form Section -->
      <div class="row mb-4" id="reservationForm">
        <div class="col">
          <div class="form-container">
            <h4 class="mb-3">
              <i class="fas fa-calendar-plus me-2"></i>
              #{reservationBean.editingMode ? 'Edit Reservation' : 'New Reservation'}
            </h4>

            <h:form id="reservationForm">
              <div class="row g-3">
                <div class="col-md-6">
                  <h:outputLabel for="client" value="Client" styleClass="form-label"/>
                  <h:selectOneMenu id="client" value="#{reservationBean.clientIdSelected}" styleClass="form-select" required="true" requiredMessage="The client is required">
                    <f:selectItem itemLabel="Select client..." noSelectionOption="true"/>
                    <f:selectItems value="#{reservationBean.clients}" var="client" itemLabel="#{client.name}" itemValue="#{client.id}"/>
                  </h:selectOneMenu>
                </div>

                <div class="col-md-6">
                  <h:outputLabel for="room" value="Room Number" styleClass="form-label"/>
                  <h:inputText id="room" value="#{reservationBean.reservation.roomNumber}" styleClass="form-control" required="true" requiredMessage="The room number is required"/>
                  <div class="form-text">
                    <h:outputText value="#{reservationBean.isRoomAvailable() ? 'Room available' : 'Room occupied'}"
                                  styleClass="#{reservationBean.isRoomAvailable() ? 'text-success' : 'text-danger'}"/>
                  </div>
                </div>

                <div class="col-md-6">
                  <h:outputLabel for="startDate" value="Start Date" styleClass="form-label"/>
                  <h:inputText id="startDate" value="#{reservationBean.reservation.startDate}" styleClass="form-control" required="true" requiredMessage="The start date is required"/>
                </div>

                <div class="col-md-6">
                  <h:outputLabel for="endDate" value="End Date" styleClass="form-label"/>
                  <h:inputText id="endDate" value="#{reservationBean.reservation.endDate}" styleClass="form-control" required="true" requiredMessage="The end date is required"/>
                </div>

                <div class="col-md-6">
                  <h:outputLabel for="state" value="State" styleClass="form-label"/>
                  <h:selectOneMenu id="state" value="#{reservationBean.reservation.state}" styleClass="form-select">
                    <f:selectItems value="#{reservationBean.reservationStates}" var="state" itemLabel="#{state.description}" itemValue="#{state}"/>
                  </h:selectOneMenu>
                </div>

                <div class="col-12">
                  <h:outputLabel for="observations" value="Observations" styleClass="form-label"/>
                  <h:inputTextarea id="observations" value="#{reservationBean.reservation.observations}" styleClass="form-control" rows="3"/>
                </div>
              </div>

              <div class="row mt-4">
                <div class="col">
                  <h:commandButton id="saveReservationBtn" value="#{reservationBean.editingMode ? 'Update' : 'Save'}" action="#{reservationBean.saveReservation()}" styleClass="btn btn-primary me-2" type="submit" disabled="#{not reservationBean.isRoomAvailable()}"/>
                  <h:commandButton id="cancelReservationBtn" value="Cancel" action="#{reservationBean.cancel()}" styleClass="btn btn-secondary" type="submit" immediate="true"/>
                </div>
              </div>
            </h:form>
          </div>
        </div>
      </div>

      <!-- Search Section -->
      <div class="row mb-4" id="searchSection">
        <div class="col">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title">
                <i class="fas fa-search me-2"></i>Search Reservations
              </h5>
              <h:form id="reservationSearchForm">
                <div class="row g-3">
                  <div class="col-md-8">
                    <h:inputText id="reservationSearchTerm" value="#{reservationBean.searchTerm}" placeholder="Search by room number or client name..." styleClass="form-control"/>
                  </div>
                  <div class="col-md-4">
                    <h:commandButton id="searchReservationBtn" value="Search" action="#{reservationBean.searchReservations()}" styleClass="btn btn-outline-primary me-2" type="submit"/>
                    <h:commandButton id="clearReservationBtn" value="Clear" action="#{reservationBean.clearSearch()}" styleClass="btn btn-outline-secondary" type="submit" immediate="true"/>
                  </div>
                </div>
              </h:form>
            </div>
          </div>
        </div>
      </div>

      <!-- Reservations Table -->
      <div class="row">
        <div class="col">
          <div class="table-container">
            <div class="table-responsive">
              <table class="table table-hover mb-0">
                <thead class="table-dark">
                  <tr>
                    <th>ID</th>
                    <th>Client</th>
                    <th>Room</th>
                    <th>Start Date</th>
                    <th>End Date</th>
                    <th>Days</th>
                    <th>State</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  <ui:repeat value="#{reservationBean.reservations}" var="reservation">
                    <tr>
                      <td>#{reservation.id}</td>
                      <td>#{reservation.client.name}</td>
                      <td>#{reservation.roomNumber}</td>
                      <td>#{reservation.startDate}</td>
                      <td>#{reservation.endDate}</td>
                      <td>#{reservation.calculateDurationDays()}</td>
                      <td>#{reservation.state.description}</td>
                      <td>
                        <h:form id="reservationActionForm#{reservation.id}" style="display:inline;">
                          <h:commandButton id="editReservationBtn#{reservation.id}" action="#{reservationBean.editReservation()}" styleClass="btn btn-sm btn-outline-primary me-1" type="submit">
                            <i class="fas fa-edit"></i>
                            <f:setPropertyActionListener target="#{reservationBean.reservationSelected}" value="#{reservation}"/>
                          </h:commandButton>

                          <ui:fragment rendered="#{reservation.state == 'CONFIRMED'}">
                            <h:commandButton id="cancelReservationBtn#{reservation.id}" action="#{reservationBean.cancelReservation()}" styleClass="btn btn-sm btn-outline-warning me-1" type="submit" onclick="return confirm('Are you sure you want to cancel this reservation?')">
                              <i class="fas fa-times"></i>
                              <f:setPropertyActionListener target="#{reservationBean.reservationSelected}" value="#{reservation}"/>
                            </h:commandButton>
                          </ui:fragment>

                          <ui:fragment rendered="#{reservation.state == 'CANCELLED'}">
                            <h:commandButton id="deleteReservationBtn#{reservation.id}" action="#{reservationBean.deleteReservation()}" styleClass="btn btn-sm btn-outline-danger" type="submit" onclick="return confirm('Are you sure you want to delete this reservation?')">
                              <i class="fas fa-trash"></i>
                              <f:setPropertyActionListener target="#{reservationBean.reservationSelected}" value="#{reservation}"/>
                            </h:commandButton>
                          </ui:fragment>
                        </h:form>
                      </td>
                    </tr>
                  </ui:repeat>
                  <ui:fragment rendered="#{empty reservationBean.reservations}">
                    <tr>
                      <td colspan="8" class="text-center text-muted py-4">
                        <i class="fas fa-calendar-times fa-2x mb-2"></i><br/>
                        No reservations registered
                      </td>
                    </tr>
                  </ui:fragment>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
    <script>
      function scrollToForm() {
        document.getElementById('reservationForm').scrollIntoView({ behavior: 'smooth' });
      }
      function scrollToSearch() {
        document.getElementById('searchSection').scrollIntoView({ behavior: 'smooth' });
      }
    </script>
    </f:view>
  </h:body>
</html>